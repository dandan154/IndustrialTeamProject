<html>
    <head>
        <title>wrld.time.js Demo</title>
        <script src="https://cdn-webgl.wrld3d.com/wrldjs/dist/latest/wrld.js"></script>
        <script src="wrld.time.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" />
        <link rel="stylesheet" href="wrld.time.css" />

        <!--EasyButton CDN Files-->
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.EasyButton/2.3.0/easy-button.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.EasyButton/2.3.0/easy-button.js"></script>

        <!--Import Dataset -->
        <script src="dataset.json"></script>
    </head>
    <body style="margin: 0">
        <div id="map" style="height: 80%; width: 80%"></div>

        <script>
            var map = L.Wrld.map("map", "21343d1ce0a398a7244c29e3c619ea37", {
                center: [ 56.462, -2.9707 ]
            });

            var arLen = dataset.features.length;
            var pins = [];
            var lines=[];
            var heatmapPoints = [];

            for (var i = 0; i < arLen; i++) {
              var dataCoord = dataset.features[i].geometry.coordinates

              if(dataset.features[i].geometry.type == "Point"){
                heatmapPoints.push([dataCoord[0], dataCoord[1], 80])
                pins.push(L.marker(dataCoord,
                                { time: dataset.features[i].properties.date }));
              }
              else if(dataset.features[i].geometry.type == "LineString"){
                lines.push(L.polyline(dataCoord, {time: dataset.features[i].properties.date}))
              }

            }
            var lineLen = pins.length;
            var pinLen = lines.length;
            

            var heat = L.heatLayer(heatmapPoints, {radius: 25});
            var layerGroup = L.layerGroup(heat);
            var time = L.control.timeSlider({ layer: layerGroup });

            //Variables for button
            var prevHeading = 0;
            var prevTilt = 0;
            var newHeading = 0;
            var newTilt = 0;
            var animateCamera = true;

            var menu = [
                L.easyButton(
                    '<i class="fas fa-paint-brush"></i>',
                    function(){
                        //TODO edit heatmaps colours
                    },
                    'Change the colours of the heatmap',
                    'colour-change-button'
                ),
                L.easyButton(
                    '<i class="fas fa-glasses"></i>',
                    function(){
                        //TODO edit heatmaps opacity
                    },
                    'Change the Opacity of the heatmap',
                    'opacity-button'
                ),
                L.easyButton(
                    '<i class="fas fa-redo-alt"></i>',
                    function(){
                        map.setView(map.getCenter(), map.getZoom(), {
                        headingDegrees: newHeading,
                        tiltDegrees: newTilt,
                        animate: animateCamera
                    });
                    },
                    'Reset the view',
                    'reset-view'
                )
            ];

            var zoombuttons = L.control.zoom({
             position:'topright'
            }).addTo(map);

            var toggle = L.easyButton({
                id:'toggle',
                position: 'topleft',
                states: [{
                  stateName: 'turn-on',
                  icon: 'Turn Heatmap On <i class="fas fa-toggle-off"></i>',
                  title: 'Turn On Heatmap',

                  /**
                   * This controls what happens when the button is clicked
                   */
                  onClick: function(control) {
                    prevHeading = map.getCameraHeadingDegrees();
                    prevTilt = map.getCameraTiltDegrees();
                    console.log(animateCamera);
                    map.setView(map.getCenter(), map.getZoom(), {
                        headingDegrees: newHeading,
                        tiltDegrees: newTilt,
                        animate: animateCamera
                    });
                    setTimeout(function() {
                        map.setCameraHeadingDegrees(newHeading).setCameraTiltDegrees(newTilt);
                      }, 1000);
                    map.addControl(time);
                    L.easyBar(menu).addTo(map);
                    heat.addTo(map);
                    for(var i = 0; i < lineLen; i++){
                        lines[i].addTo(map);
                    }

                    for(var i=0; i<pinLen; i++){
                        pins[i].addTo(map);
                    }
                    control.state('turn-off'); //This is the stateName this button changes to
                  }
                }, {
                  icon: 'Turn Heatmap Off <i class="fas fa-toggle-on"></i>',
                  stateName: 'turn-off',
                  title: 'Turn Off Heatmap',

                  /**
                   * This controls what happens when the button is clicked
                   */
                  onClick: function(control) {
                    map.setView(map.getCenter(), map.getZoom(), {
                        headingDegrees: prevHeading,
                        tiltDegrees: prevTilt,
                        animate: animateCamera
                    });
                    setTimeout(function() {
                        map.setCameraHeadingDegrees(prevHeading).setCameraTiltDegrees(prevTilt);
                      }, 1000);
                    L.easyBar(menu).remove(map);
                    time.remove(map);
                    heat.remove(map);
                    for(var i = 0; i < lineLen; i++){
                        lines[i].remove(map);
                    }

                    for(var i=0; i<pinLen; i++){
                        pins[i].remove(map);
                    }
                    control.state('turn-on'); //This is the stateName this button changes to
                  }
                }]
            });
            toggle.addTo(map);


            /** var zoom = [
                L.easyButton(
                    '<i class="fas fa-plus"></i>',
                    function(){
                        //TODO make a zoom in function
                    },
                    'Zoom In'
                ),
                L.easyButton(
                    '<i class="fas fa-minus"></i>',
                    function(){
                        //TODO make a zoom out function
                    },
                    'Zoom Out'
                )
            ];
            L.easyBar(zoom).addTo(map); //TODO sort out positioning of this element
            */

            /**
             * This is the on/off switch for the heatmap
             */
        </script>
        <br>
    </body>
</html>
