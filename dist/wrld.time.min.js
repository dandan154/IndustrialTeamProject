!function(){"use strict";function t(i){return this instanceof t?(this._canvas=i="string"==typeof i?document.getElementById(i):i,this._ctx=i.getContext("2d"),this._width=i.width,this._height=i.height,this._max=1,void this.clear()):new t(i)}t.prototype={defaultRadius:25,defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},data:function(t,i){return this._data=t,this},max:function(t){return this._max=t,this},add:function(t){return this._data.push(t),this},clear:function(){return this._data=[],this},radius:function(t,i){i=i||15;var a=this._circle=document.createElement("canvas"),s=a.getContext("2d"),e=this._r=t+i;return a.width=a.height=2*e,s.shadowOffsetX=s.shadowOffsetY=200,s.shadowBlur=i,s.shadowColor="black",s.beginPath(),s.arc(e-200,e-200,t,0,2*Math.PI,!0),s.closePath(),s.fill(),this},gradient:function(t){var i=document.createElement("canvas"),a=i.getContext("2d"),s=a.createLinearGradient(0,0,0,256);for(var e in i.width=1,i.height=256,t)s.addColorStop(e,t[e]);return a.fillStyle=s,a.fillRect(0,0,1,256),this._grad=a.getImageData(0,0,1,256).data,this},draw:function(t){this._circle||this.radius(this.defaultRadius),this._grad||this.gradient(this.defaultGradient);var i=this._ctx;i.clearRect(0,0,this._width,this._height);for(var a,s=0,e=this._data.length;e>s;s++)a=this._data[s],i.globalAlpha=Math.max(a[2]/this._max,t||.05),i.drawImage(this._circle,a[0]-this._r,a[1]-this._r);var n=i.getImageData(0,0,this._width,this._height);return this._colorize(n.data,this._grad),i.putImageData(n,0,0),this},_colorize:function(t,i){for(var a,s=3,e=t.length;e>s;s+=4)(a=4*t[s])&&(t[s-3]=i[a],t[s-2]=i[a+1],t[s-1]=i[a+2])}},window.simpleheat=t}(),L.HeatLayer=(L.Layer?L.Layer:L.Class).extend({options:{intensityFactor:40},initialize:function(latlngs,options){this._latlngs=latlngs,L.setOptions(this,options)},setLatLngs:function(latlngs){return this._latlngs=latlngs,this.redraw()},addLatLng:function(latlng){return this._latlngs.push(latlng),this.redraw()},setOptions:function(options){return L.setOptions(this,options),this._heat&&this._updateOptions(),this.redraw()},redraw:function(){return this._heat&&!this._frame&&this._map&&!this._map._animating&&(this._frame=L.Util.requestAnimFrame(this._redraw,this)),this},onAdd:function(map){this._map=map,this._canvas||this._initCanvas(),this.options.pane?this.getPane().appendChild(this._canvas):map._panes.overlayPane.appendChild(this._canvas),map.on("moveend",this._reset,this),map.options.zoomAnimation&&L.Browser.any3d&&map.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(map){this.options.pane?this.getPane().removeChild(this._canvas):map.getPanes().overlayPane.removeChild(this._canvas),map.off("moveend",this._reset,this),map.options.zoomAnimation&&map.off("zoomanim",this._animateZoom,this)},addTo:function(map){return map.addLayer(this),this},_initCanvas:function(){var canvas=this._canvas=L.DomUtil.create("canvas","leaflet-heatmap-layer leaflet-layer"),originProp=L.DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","msTransformOrigin"]);canvas.style[originProp]="50% 50%";var size=this._map.getSize();canvas.width=size.x,canvas.height=size.y;var animated=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(canvas,"leaflet-zoom-"+(animated?"animated":"hide")),this._heat=simpleheat(canvas),this._updateOptions()},_updateOptions:function(){this._heat.radius(this.options.radius||this._heat.defaultRadius,this.options.blur),this.options.gradient&&this._heat.gradient(this.options.gradient),this.options.max&&this._heat.max(this.options.max)},_reset:function(){var topLeft=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,topLeft);var size=this._map.getSize();this._heat._width!==size.x&&(this._canvas.width=this._heat._width=size.x),this._heat._height!==size.y&&(this._canvas.height=this._heat._height=size.y),this._redraw()},_redraw:function(){if(this._map){var data=[],r=this._heat._r,size=this._map.getSize(),bounds=new L.Bounds(L.point([-r,-r]),size.add([r,r])),max=void 0===this.options.max?1:this.options.max,maxZoom=void 0===this.options.maxZoom?this._map.getMaxZoom():this.options.maxZoom,v=1/Math.pow(2,Math.max(0,Math.min(maxZoom-this._map.getZoom(),12))),cellSize=r/2,grid=[],panePos=this._map._getMapPanePos(),offsetX=panePos.x%cellSize,offsetY=panePos.y%cellSize,i,len,p,cell,x,y,j,len2,k;for(i=0,len=this._latlngs.length;i<len;i++){var intensity;if(this._latlngs[i].length>3&&(this._latlngs[i]=this._latlngs[i].slice(0,3)),p=this._map.latLngToContainerPoint(this._latlngs[i]),bounds.contains(p))x=Math.floor((p.x-offsetX)/cellSize)+2,y=Math.floor((p.y-offsetY)/cellSize)+2,k=v*(this._latlngs[i][3]||1)*this.options.intensityFactor,grid[y]=grid[y]||[],(cell=grid[y][x])?(cell[0]=(cell[0]*cell[2]+p.x*k)/(cell[2]+k),cell[1]=(cell[1]*cell[2]+p.y*k)/(cell[2]+k),cell[2]+=k):grid[y][x]=[p.x,p.y,k]}for(i=0,len=grid.length;i<len;i++)if(grid[i])for(j=0,len2=grid[i].length;j<len2;j++)(cell=grid[i][j])&&data.push([Math.round(cell[0]),Math.round(cell[1]),Math.min(cell[2],max)]);this._heat.data(data).draw(this.options.minOpacity),this._frame=null}},_animateZoom:function(e){var scale=this._map.getZoomScale(e.zoom),offset=this._map._getCenterOffset(e.center)._multiplyBy(-scale).subtract(this._map._getMapPanePos());L.DomUtil.setTransform?L.DomUtil.setTransform(this._canvas,offset,scale):this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(offset)+" scale("+scale+")"}}),L.heatLayer=function(latlngs,options){return new L.HeatLayer(latlngs,options)},Date.prototype.daysFrom=function(other){return Math.round(Math.abs((this.getTime()-other.getTime())/864e5))},Date.prototype.addDays=function(days){var date=new Date(this.valueOf());return date.setDate(date.getDate()+days),date};class WrldTime{constructor(map,data,options={}){if(this.options={heatmap:options.heatmap||!1,heatmapOptions:options.heatmapOptions||{},showIndoorPointsExternally:!1,heatmapIntensity:options.heatmapIntensity||50,indoorHeatmapIntensity:options.indoorHeatmapIntensity||1,verticalPosition:options.verticalPosition||"top",horizontalPosition:options.horizontalPosition||"left",style:options.style},this._map=map,"string"==typeof data){var req=new XMLHttpRequest,url=data;req.onreadystatechange=(e=>{if(4==req.readyState&&200==req.status){let res=JSON.parse(req.responseText);console.log(res),this.setData(res),this.displaySlider()}}),req.open("GET",url,!0),req.send()}else this.setData(data),this.displaySlider();this._map.indoors.on("indoormapenter",()=>{var changed=!1;null!=this._layer&&(this._layer.options.indoorMapId=this._map.indoors.getActiveIndoorMap().getIndoorMapId(),this._layer.options.indoorMapFloorId=this._map.indoors.getFloor().getFloorIndex(),changed=!0),null!=this._heatmapLayer&&(this._heatmapLayer.options.indoorMapId=this._map.indoors.getActiveIndoorMap().getIndoorMapId(),this._heatmapLayer.options.indoorMapFloorId=this._map.indoors.getFloor().getFloorIndex(),this._heatmapLayer.options.intensityFactor=this.options.indoorHeatmapIntensity,changed=!0),changed&&this.setupTimeLayer()}),this._map.indoors.on("indoormapexit",()=>{var changed=!1;null!=this._layer&&(this._layer.options.indoorMapId=void 0,this._layer.options.indoorMapFloorId=void 0,changed=!0),null!=this._heatmapLayer&&(this._heatmapLayer.options.indoorMapId=void 0,this._heatmapLayer.options.indoorMapFloorId=void 0,this._heatmapLayer.options.intensityFactor=this.options.heatmapIntensity,changed=!0),changed&&this.setupTimeLayer()}),this._map.indoors.on("indoormapfloorchange",this.setupTimeLayer.bind(this))}setData(data){var _minDate,_maxDate;this.data=data,data.features.forEach(feature=>{var date=new Date(feature.properties.date);null==_minDate&&(_minDate=date),null==_maxDate&&(_maxDate=date),date<=_minDate&&(_minDate=date),date>=_maxDate&&(_maxDate=date)}),this._minDate=_minDate,this._steps=_minDate.daysFrom(_maxDate),this.setupTimeLayer()}displaySlider(){switch(null==this._container&&(this._container=document.createElement("div"),this._sliderContainer=document.createElement("div"),this._slider=document.createElement("input"),this._sliderTimestamp=document.createElement("span")),this._container.id="wrld-time-container",this._sliderTimestamp.id="wrld-time-timestamp",this._sliderTimestamp.innerHTML=this._minDate.toLocaleDateString("en-GB"),this._slider.type="range",this._slider.classList.add("time-slider"),this._slider.addEventListener("input",this.handleSliderChange.bind(this)),this._slider.min=0,this._slider.max=this._steps,this._slider.value=0,this._sliderContainer.innerHTML="Date: ",this._sliderContainer.append(this._sliderTimestamp),this._sliderContainer.innerHTML+="<br/>",this._sliderContainer.append(this._slider),this._sliderContainer.classList.add("time-slider-container"),this._container.append(this._sliderContainer),this._container.classList.add("time-container"),this.options.verticalPosition){case"top":this._container.style.alignItems="flex-start";break;case"bottom":this._container.style.alignItems="flex-end"}switch(this.options.horizontalPosition){case"left":this._container.style.justifyContent="flex-start";break;case"center":this._container.style.justifyContent="center";break;case"right":this._container.style.justifyContent="flex-end"}var wrldContainer=this._map._container.parentElement.parentElement;wrldContainer.style.position="relative",wrldContainer.append(this._container)}handleSliderChange(){var sliderTimestamp=document.getElementById("wrld-time-timestamp");if(null!=sliderTimestamp){var date=this._minDate.addDays(+this._slider.value);sliderTimestamp.innerHTML=date.toLocaleDateString("en-US")}this.setupTimeLayer()}setupTimeLayer(){if(null!=this._layer&&this._layer.remove(),null!=this.data&&(this._layer=L.geoJSON(this.data,{pointToLayer:function(geoJsonPoint,latlng){var props=geoJsonPoint.properties,opts={};return null!=props.elevation&&(opts.elevation=props.elevation),null!=props.elevationMode&&(opts.elevationMode=props.elevationMode),null!=props.indoorMapId&&(opts.indoorMapId=props.indoorMapId),null!=props.indoorMapFloorId&&(opts.indoorMapFloorId=props.indoorMapFloorId),L.marker(latlng,opts)},style:this.options.style,filter:this.shouldShowFeature.bind(this)}),0!=Object.keys(this._layer._layers).length&&this._layer.addTo(this._map),this.options.heatmap)){let heatmapPoints=[];this.data.features.forEach(feature=>{if(this.shouldShowFeature(feature,!0)){var coords=Array.from(feature.geometry.coordinates),tmp=coords[0];coords[0]=coords[1],coords[1]=tmp,coords.length<3&&(this._map.indoors.isIndoors()?(console.log(coords),coords[2]=this._map.indoors.getFloorHeightAboveSeaLevel(this._map.indoors.getFloor().getFloorIndex())-this._map.getAltitudeAtLatLng(L.latLng(coords))):coords[2]=1),feature.properties.intensity&&(coords[3]=feature.properties.intensity),(feature.type=null==coords[0].length)&&heatmapPoints.push(coords)}}),heatmapPoints.length>0&&(null!=this._heatmapLayer?this._heatmapLayer.setLatLngs(heatmapPoints):this._heatmapLayer=L.heatLayer(heatmapPoints,this.options.heatmapOptions).addTo(this._map))}}shouldShowFeature(feature,heatmap=!1){var isIndoors=this._map.indoors.isIndoors(),featureIsIndoors=null!=feature.properties.indoorMapId;if(!heatmap&&this.options.heatmap&&"Point"==feature.geometry.type)return!1;if(isIndoors){var floor=this._map.indoors.getFloor().getFloorIndex();if(!featureIsIndoors)return!1;if(feature.properties.indoorMapFloorId!=floor)return!1}else if(!this.options.showIndoorPointsExternally&&featureIsIndoors)return!1;return new Date(feature.properties.date)<=this._minDate.addDays(this._slider?this._slider.value:0)}}function wrldTime(map,data,options){return new WrldTime(map,data,options)}