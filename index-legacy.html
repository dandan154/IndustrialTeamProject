<html>
    <head>
        <title>wrld.time.js Demo</title>

        <script src="wrld.time.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" />
        <link rel="stylesheet" href="wrld.time.css" />

        <!--EasyButton CDN Files-->
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.EasyButton/2.3.0/easy-button.css" rel="stylesheet"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">

        <!--Import Dataset -->
        <script src="dataset.json"></script>
    </head>
    <body style="margin: 0">
        <div id="map" style="height: 80%; width: 80%"></div>

        <script>
            var map = L.Wrld.map("map", "21343d1ce0a398a7244c29e3c619ea37", {
                center: [ 56.462, -2.9707 ]
            });

            var arLen = dataset.features.length;
            var pins = [];
            var lines=[];
            var heatmapPoints = [];

            for (var i = 0; i < arLen; i++) {
              var dataCoord = dataset.features[i].geometry.coordinates

              if(dataset.features[i].geometry.type == "Point"){
                heatmapPoints.push([dataCoord[0], dataCoord[1], 80])
                pins.push(L.marker(dataCoord,
                                { time: dataset.features[i].properties.date }));
              }
              else if(dataset.features[i].geometry.type == "LineString"){
                lines.push(L.polyline(dataCoord, {time: dataset.features[i].properties.date}))
              }

            }
            var lineLen = pins.length;
            var pinLen = lines.length;
            

            var heat = L.heatLayer(heatmapPoints, {radius: 25});
            var layerGroup = L.layerGroup(heat);
            var time = L.control.timeSlider({ layer: layerGroup });

            //Variables for button
            var prevHeading = 0;
            var prevTilt = 0;
            var newHeading = 0;
            var newTilt = 0;
            var animateCamera = true;

            /**
             * This array stores the buttons for the heatmap menu
             */
            var menu = [
                
                //This is the colour button
                L.easyButton(
                    '<i class="fas fa-paint-brush"></i>',
                    function(){
                        //TODO edit heatmaps colours
                    },
                    'Change the colours of the heatmap',
                    'colour-change-button'
                ),
                
                //This is the Opacity button
                L.easyButton(
                    '<i class="fas fa-glasses"></i>',
                    function(){
                        //TODO edit heatmaps opacity
                    },
                    'Change the Opacity of the heatmap',
                    'opacity-button'
                ),
        
                //This is the manual birds eye view button
                L.easyButton(
                    '<i class="fas fa-redo-alt"></i>',
                    function(){
                        map.setView(map.getCenter(), map.getZoom(), {
                        headingDegrees: newHeading,
                        tiltDegrees: newTilt,
                        animate: animateCamera
                    });
                    },
                    'Reset the view',
                    'reset-view'
                )
            ];

            var menuTest = L.easyBar(menu) ; 
            
            /**
             * This variable controls the physical zoom buttons on the map
             */
            var zoombuttons = L.control.zoom({
             position:'topright'
            }).addTo(map);

            /**
             * This is the on/off switch for the heatmap
             */
            var toggle = L.easyButton({
                id:'toggle',
                position: 'topleft',
                states: [{
                  stateName: 'turn-on',
                  icon: 'Turn Heatmap On <i class="fas fa-toggle-off"></i>',
                  title: 'Turn On Heatmap',

                  /**
                   * This controls what happens when the button is clicked
                   */
                  onClick: function(control) {
                    
                    //Sets the previous heading and tilt for the camera when heatmap is toggled off
                    prevHeading = map.getCameraHeadingDegrees();
                    prevTilt = map.getCameraTiltDegrees();
                    console.log(animateCamera);
                    
                    //This changes the view
                    map.setView(map.getCenter(), map.getZoom(), {
                        headingDegrees: this._newHeading,
                        tiltDegrees: newTilt,
                        animate: animateCamera
                    });
                    
                    //Adds the slider to the map
                    map.addControl(time);
                    
                    //Adds the heatmap menu
                    menuTest.addTo(map);
                    
                    //Adds the heatmap layer
                    heat.addTo(map);
                    
                    //Adds the lines and pins
                    for(var i = 0; i < lineLen; i++){
                        lines[i].addTo(map);
                    }

                    for(var i=0; i<pinLen; i++){
                        pins[i].addTo(map);
                    }
                    
                    //Changes the control state
                    control.state('turn-off'); //This is the stateName this button changes to
                  }
                }, {
                  icon: 'Turn Heatmap Off <i class="fas fa-toggle-on"></i>',
                  stateName: 'turn-off',
                  title: 'Turn Off Heatmap',

                  /**
                   * This controls what happens when the button is clicked
                   */
                  onClick: function(control) {
                      
                    //Sets the view the button toggles
                    map.setView(map.getCenter(), map.getZoom(), {
                        headingDegrees: prevHeading,
                        tiltDegrees: prevTilt,
                        animate: animateCamera
                    });
                    
                    //Removes the heatmap menu
                    menuTest.remove(map);
                    
                    //Removes the slider
                    time.remove(map);
                    
                    //Removes the heatmap
                    heat.remove(map);
                    
                    //Removes the lines and icons
                    for(var i = 0; i < lineLen; i++){
                        lines[i].remove(map);
                    }

                    for(var i=0; i<pinLen; i++){
                        pins[i].remove(map);
                    }
                    
                    //Changes the button state
                    control.state('turn-on'); //This is the stateName this button changes to
                  }
                }]
            });
            
            //Adds the toggle button to the map
            this._toggle.addTo(map);           
        </script>
        <br>
    </body>
</html>
